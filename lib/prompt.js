'use strict';

var necessary = require('necessary');

var constants = require('./constants');

var _process = process,
    stdin = _process.stdin,
    stdout = _process.stdout,
    asynchronousUtilities = necessary.asynchronousUtilities,
    whilst = asynchronousUtilities.whilst,
    CTRL_C = constants.CTRL_C,
    LINE_FEED = constants.LINE_FEED,
    CARRIAGE_RETURN = constants.CARRIAGE_RETURN,
    BACKSPACE = constants.BACKSPACE;


function prompt(options, callback) {
  var value = null,
      context = Object.assign(options, {
    value: value
  });

  whilst(attempt, function () {
    var value = context.value;


    callback(value);
  }, context);
}

module.exports = prompt;

function attempt(next, done, context) {
  var attempts = context.attempts;


  var terminate = attempts-- === 0;

  if (terminate) {
    done();

    return;
  }

  var description = context.description,
      validationPattern = context.validationPattern,
      validationFunction = context.validationFunction,
      errorMessage = context.errorMessage,
      hidden = context.hidden;


  hidden ? hiddenInput(description, callback) : visibleInput(description, callback);

  function callback(value) {
    var valid = validationFunction ? ///
    validationFunction(value) : validationPattern.test(value);

    if (valid) {
      Object.assign(context, {
        value: value
      });

      done();
    } else {
      console.log(errorMessage);

      Object.assign(context, {
        attempts: attempts
      });

      next();
    }
  }
}

function visibleInput(description, callback) {
  var encoding = 'utf8',
      rawMode = false;

  stdout.write(description);

  stdin.setEncoding(encoding);

  stdin.setRawMode(rawMode);

  stdin.resume();

  stdin.on('data', function (chunk) {
    var value = chunk.trim();

    stdin.removeAllListeners('data');

    stdin.pause();

    callback(value);
  });
}

function hiddenInput(description, callback) {
  var encoding = 'utf8',
      rawMode = true;

  stdout.write(description);

  stdin.setEncoding(encoding);

  stdin.setRawMode(rawMode);

  stdin.resume();

  var value = '';

  stdin.on('data', function (chunk) {
    var char = chunk.toString(encoding);

    switch (char) {
      case LINE_FEED:
      case CARRIAGE_RETURN:
        stdout.write(LINE_FEED);

        stdin.removeAllListeners('data');

        stdin.pause();

        callback(value);
        break;

      case CTRL_C:
        console.log();

        process.exit();
        break;

      case BACKSPACE:
        value = truncate(value);

        stdout.clearLine();

        stdout.cursorTo(0);

        stdout.write(description);
        break;

      default:
        value += char;
        break;
    }
  });
}

function truncate(value) {
  return value.slice(0, value.length - 1);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9wcm9tcHQuanMiXSwibmFtZXMiOlsibmVjZXNzYXJ5IiwicmVxdWlyZSIsImNvbnN0YW50cyIsInByb2Nlc3MiLCJzdGRpbiIsInN0ZG91dCIsImFzeW5jaHJvbm91c1V0aWxpdGllcyIsIndoaWxzdCIsIkNUUkxfQyIsIkxJTkVfRkVFRCIsIkNBUlJJQUdFX1JFVFVSTiIsIkJBQ0tTUEFDRSIsInByb21wdCIsIm9wdGlvbnMiLCJjYWxsYmFjayIsInZhbHVlIiwiY29udGV4dCIsIk9iamVjdCIsImFzc2lnbiIsImF0dGVtcHQiLCJtb2R1bGUiLCJleHBvcnRzIiwibmV4dCIsImRvbmUiLCJhdHRlbXB0cyIsInRlcm1pbmF0ZSIsImRlc2NyaXB0aW9uIiwidmFsaWRhdGlvblBhdHRlcm4iLCJ2YWxpZGF0aW9uRnVuY3Rpb24iLCJlcnJvck1lc3NhZ2UiLCJoaWRkZW4iLCJoaWRkZW5JbnB1dCIsInZpc2libGVJbnB1dCIsInZhbGlkIiwidGVzdCIsImNvbnNvbGUiLCJsb2ciLCJlbmNvZGluZyIsInJhd01vZGUiLCJ3cml0ZSIsInNldEVuY29kaW5nIiwic2V0UmF3TW9kZSIsInJlc3VtZSIsIm9uIiwiY2h1bmsiLCJ0cmltIiwicmVtb3ZlQWxsTGlzdGVuZXJzIiwicGF1c2UiLCJjaGFyIiwidG9TdHJpbmciLCJleGl0IiwidHJ1bmNhdGUiLCJjbGVhckxpbmUiLCJjdXJzb3JUbyIsInNsaWNlIiwibGVuZ3RoIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQSxJQUFNQSxZQUFZQyxRQUFRLFdBQVIsQ0FBbEI7O0FBRUEsSUFBTUMsWUFBWUQsUUFBUSxhQUFSLENBQWxCOztlQUUwQkUsTztJQUFsQkMsSyxZQUFBQSxLO0lBQU9DLE0sWUFBQUEsTTtJQUNQQyxxQixHQUEwQk4sUyxDQUExQk0scUI7SUFDQUMsTSxHQUFXRCxxQixDQUFYQyxNO0lBQ0FDLE0sR0FBa0ROLFMsQ0FBbERNLE07SUFBUUMsUyxHQUEwQ1AsUyxDQUExQ08sUztJQUFXQyxlLEdBQStCUixTLENBQS9CUSxlO0lBQWlCQyxTLEdBQWNULFMsQ0FBZFMsUzs7O0FBRTVDLFNBQVNDLE1BQVQsQ0FBZ0JDLE9BQWhCLEVBQXlCQyxRQUF6QixFQUFtQztBQUNqQyxNQUFNQyxRQUFRLElBQWQ7QUFBQSxNQUNNQyxVQUFVQyxPQUFPQyxNQUFQLENBQWNMLE9BQWQsRUFBdUI7QUFDL0JFLFdBQU9BO0FBRHdCLEdBQXZCLENBRGhCOztBQUtBUixTQUFPWSxPQUFQLEVBQWdCLFlBQVc7QUFBQSxRQUNqQkosS0FEaUIsR0FDUEMsT0FETyxDQUNqQkQsS0FEaUI7OztBQUd6QkQsYUFBU0MsS0FBVDtBQUNELEdBSkQsRUFJR0MsT0FKSDtBQUtEOztBQUVESSxPQUFPQyxPQUFQLEdBQWlCVCxNQUFqQjs7QUFFQSxTQUFTTyxPQUFULENBQWlCRyxJQUFqQixFQUF1QkMsSUFBdkIsRUFBNkJQLE9BQTdCLEVBQXNDO0FBQUEsTUFDOUJRLFFBRDhCLEdBQ2pCUixPQURpQixDQUM5QlEsUUFEOEI7OztBQUdwQyxNQUFNQyxZQUFhRCxlQUFlLENBQWxDOztBQUVBLE1BQUlDLFNBQUosRUFBZTtBQUNiRjs7QUFFQTtBQUNEOztBQVRtQyxNQVc1QkcsV0FYNEIsR0FXaURWLE9BWGpELENBVzVCVSxXQVg0QjtBQUFBLE1BV2ZDLGlCQVhlLEdBV2lEWCxPQVhqRCxDQVdmVyxpQkFYZTtBQUFBLE1BV0lDLGtCQVhKLEdBV2lEWixPQVhqRCxDQVdJWSxrQkFYSjtBQUFBLE1BV3dCQyxZQVh4QixHQVdpRGIsT0FYakQsQ0FXd0JhLFlBWHhCO0FBQUEsTUFXc0NDLE1BWHRDLEdBV2lEZCxPQVhqRCxDQVdzQ2MsTUFYdEM7OztBQWFwQ0EsV0FDRUMsWUFBWUwsV0FBWixFQUF5QlosUUFBekIsQ0FERixHQUVJa0IsYUFBYU4sV0FBYixFQUEwQlosUUFBMUIsQ0FGSjs7QUFJQSxXQUFTQSxRQUFULENBQWtCQyxLQUFsQixFQUF5QjtBQUN2QixRQUFNa0IsUUFBUUwscUJBQXNCO0FBQ3BCQSx1QkFBbUJiLEtBQW5CLENBREYsR0FFSVksa0JBQWtCTyxJQUFsQixDQUF1Qm5CLEtBQXZCLENBRmxCOztBQUlBLFFBQUlrQixLQUFKLEVBQVc7QUFDVGhCLGFBQU9DLE1BQVAsQ0FBY0YsT0FBZCxFQUF1QjtBQUNyQkQsZUFBT0E7QUFEYyxPQUF2Qjs7QUFJQVE7QUFDRCxLQU5ELE1BTU87QUFDTFksY0FBUUMsR0FBUixDQUFZUCxZQUFaOztBQUVBWixhQUFPQyxNQUFQLENBQWNGLE9BQWQsRUFBdUI7QUFDckJRLGtCQUFVQTtBQURXLE9BQXZCOztBQUlBRjtBQUNEO0FBQ0Y7QUFDRjs7QUFFRCxTQUFTVSxZQUFULENBQXNCTixXQUF0QixFQUFtQ1osUUFBbkMsRUFBNkM7QUFDM0MsTUFBTXVCLFdBQVcsTUFBakI7QUFBQSxNQUNNQyxVQUFVLEtBRGhCOztBQUdBakMsU0FBT2tDLEtBQVAsQ0FBYWIsV0FBYjs7QUFFQXRCLFFBQU1vQyxXQUFOLENBQWtCSCxRQUFsQjs7QUFFQWpDLFFBQU1xQyxVQUFOLENBQWlCSCxPQUFqQjs7QUFFQWxDLFFBQU1zQyxNQUFOOztBQUVBdEMsUUFBTXVDLEVBQU4sQ0FBUyxNQUFULEVBQWlCLFVBQVVDLEtBQVYsRUFBaUI7QUFDaEMsUUFBTTdCLFFBQVE2QixNQUFNQyxJQUFOLEVBQWQ7O0FBRUF6QyxVQUFNMEMsa0JBQU4sQ0FBeUIsTUFBekI7O0FBRUExQyxVQUFNMkMsS0FBTjs7QUFFQWpDLGFBQVNDLEtBQVQ7QUFDRCxHQVJEO0FBU0Q7O0FBRUQsU0FBU2dCLFdBQVQsQ0FBcUJMLFdBQXJCLEVBQWtDWixRQUFsQyxFQUE0QztBQUMxQyxNQUFNdUIsV0FBVyxNQUFqQjtBQUFBLE1BQ01DLFVBQVUsSUFEaEI7O0FBR0FqQyxTQUFPa0MsS0FBUCxDQUFhYixXQUFiOztBQUVBdEIsUUFBTW9DLFdBQU4sQ0FBa0JILFFBQWxCOztBQUVBakMsUUFBTXFDLFVBQU4sQ0FBaUJILE9BQWpCOztBQUVBbEMsUUFBTXNDLE1BQU47O0FBRUEsTUFBSTNCLFFBQVEsRUFBWjs7QUFFQVgsUUFBTXVDLEVBQU4sQ0FBUyxNQUFULEVBQWlCLFVBQVVDLEtBQVYsRUFBaUI7QUFDaEMsUUFBTUksT0FBT0osTUFBTUssUUFBTixDQUFlWixRQUFmLENBQWI7O0FBRUEsWUFBUVcsSUFBUjtBQUNFLFdBQUt2QyxTQUFMO0FBQ0EsV0FBS0MsZUFBTDtBQUNFTCxlQUFPa0MsS0FBUCxDQUFhOUIsU0FBYjs7QUFFQUwsY0FBTTBDLGtCQUFOLENBQXlCLE1BQXpCOztBQUVBMUMsY0FBTTJDLEtBQU47O0FBRUFqQyxpQkFBU0MsS0FBVDtBQUNBOztBQUVGLFdBQUtQLE1BQUw7QUFDRTJCLGdCQUFRQyxHQUFSOztBQUVBakMsZ0JBQVErQyxJQUFSO0FBQ0E7O0FBRUYsV0FBS3ZDLFNBQUw7QUFDRUksZ0JBQVFvQyxTQUFTcEMsS0FBVCxDQUFSOztBQUVBVixlQUFPK0MsU0FBUDs7QUFFQS9DLGVBQU9nRCxRQUFQLENBQWdCLENBQWhCOztBQUVBaEQsZUFBT2tDLEtBQVAsQ0FBYWIsV0FBYjtBQUNBOztBQUVGO0FBQ0VYLGlCQUFTaUMsSUFBVDtBQUNBO0FBOUJKO0FBZ0NELEdBbkNEO0FBb0NEOztBQUVELFNBQVNHLFFBQVQsQ0FBa0JwQyxLQUFsQixFQUF5QjtBQUFFLFNBQU9BLE1BQU11QyxLQUFOLENBQVksQ0FBWixFQUFldkMsTUFBTXdDLE1BQU4sR0FBZSxDQUE5QixDQUFQO0FBQTBDIiwiZmlsZSI6InByb21wdC5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgbmVjZXNzYXJ5ID0gcmVxdWlyZSgnbmVjZXNzYXJ5Jyk7XG5cbmNvbnN0IGNvbnN0YW50cyA9IHJlcXVpcmUoJy4vY29uc3RhbnRzJyk7XG5cbmNvbnN0IHsgc3RkaW4sIHN0ZG91dCB9ID0gcHJvY2VzcyxcbiAgICAgIHsgYXN5bmNocm9ub3VzVXRpbGl0aWVzIH0gPSBuZWNlc3NhcnksXG4gICAgICB7IHdoaWxzdCB9ID0gYXN5bmNocm9ub3VzVXRpbGl0aWVzLFxuICAgICAgeyBDVFJMX0MsIExJTkVfRkVFRCwgQ0FSUklBR0VfUkVUVVJOLCBCQUNLU1BBQ0UgfSA9IGNvbnN0YW50cztcblxuZnVuY3Rpb24gcHJvbXB0KG9wdGlvbnMsIGNhbGxiYWNrKSB7XG4gIGNvbnN0IHZhbHVlID0gbnVsbCxcbiAgICAgICAgY29udGV4dCA9IE9iamVjdC5hc3NpZ24ob3B0aW9ucywge1xuICAgICAgICAgIHZhbHVlOiB2YWx1ZVxuICAgICAgICB9KTtcblxuICB3aGlsc3QoYXR0ZW1wdCwgZnVuY3Rpb24oKSB7XG4gICAgY29uc3QgeyB2YWx1ZSB9ID0gY29udGV4dDtcbiAgICBcbiAgICBjYWxsYmFjayh2YWx1ZSk7XG4gIH0sIGNvbnRleHQpO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHByb21wdDtcblxuZnVuY3Rpb24gYXR0ZW1wdChuZXh0LCBkb25lLCBjb250ZXh0KSB7XG4gIGxldCB7IGF0dGVtcHRzIH0gPSBjb250ZXh0O1xuXG4gIGNvbnN0IHRlcm1pbmF0ZSA9IChhdHRlbXB0cy0tID09PSAwKTtcbiAgXG4gIGlmICh0ZXJtaW5hdGUpIHtcbiAgICBkb25lKCk7XG4gICAgXG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3QgeyBkZXNjcmlwdGlvbiwgdmFsaWRhdGlvblBhdHRlcm4sIHZhbGlkYXRpb25GdW5jdGlvbiwgZXJyb3JNZXNzYWdlLCBoaWRkZW4gfSA9IGNvbnRleHQ7XG5cbiAgaGlkZGVuID8gXG4gICAgaGlkZGVuSW5wdXQoZGVzY3JpcHRpb24sIGNhbGxiYWNrKSA6XG4gICAgICB2aXNpYmxlSW5wdXQoZGVzY3JpcHRpb24sIGNhbGxiYWNrKTtcblxuICBmdW5jdGlvbiBjYWxsYmFjayh2YWx1ZSkge1xuICAgIGNvbnN0IHZhbGlkID0gdmFsaWRhdGlvbkZ1bmN0aW9uID8gIC8vL1xuICAgICAgICAgICAgICAgICAgICB2YWxpZGF0aW9uRnVuY3Rpb24odmFsdWUpIDpcbiAgICAgICAgICAgICAgICAgICAgICB2YWxpZGF0aW9uUGF0dGVybi50ZXN0KHZhbHVlKTtcblxuICAgIGlmICh2YWxpZCkge1xuICAgICAgT2JqZWN0LmFzc2lnbihjb250ZXh0LCB7XG4gICAgICAgIHZhbHVlOiB2YWx1ZVxuICAgICAgfSk7XG5cbiAgICAgIGRvbmUoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc29sZS5sb2coZXJyb3JNZXNzYWdlKTtcblxuICAgICAgT2JqZWN0LmFzc2lnbihjb250ZXh0LCB7XG4gICAgICAgIGF0dGVtcHRzOiBhdHRlbXB0c1xuICAgICAgfSk7XG5cbiAgICAgIG5leHQoKTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gdmlzaWJsZUlucHV0KGRlc2NyaXB0aW9uLCBjYWxsYmFjaykge1xuICBjb25zdCBlbmNvZGluZyA9ICd1dGY4JyxcbiAgICAgICAgcmF3TW9kZSA9IGZhbHNlO1xuXG4gIHN0ZG91dC53cml0ZShkZXNjcmlwdGlvbik7XG5cbiAgc3RkaW4uc2V0RW5jb2RpbmcoZW5jb2RpbmcpO1xuXG4gIHN0ZGluLnNldFJhd01vZGUocmF3TW9kZSk7XG5cbiAgc3RkaW4ucmVzdW1lKCk7XG5cbiAgc3RkaW4ub24oJ2RhdGEnLCBmdW5jdGlvbiAoY2h1bmspIHtcbiAgICBjb25zdCB2YWx1ZSA9IGNodW5rLnRyaW0oKTtcblxuICAgIHN0ZGluLnJlbW92ZUFsbExpc3RlbmVycygnZGF0YScpO1xuXG4gICAgc3RkaW4ucGF1c2UoKTtcblxuICAgIGNhbGxiYWNrKHZhbHVlKTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGhpZGRlbklucHV0KGRlc2NyaXB0aW9uLCBjYWxsYmFjaykge1xuICBjb25zdCBlbmNvZGluZyA9ICd1dGY4JyxcbiAgICAgICAgcmF3TW9kZSA9IHRydWU7XG5cbiAgc3Rkb3V0LndyaXRlKGRlc2NyaXB0aW9uKTtcblxuICBzdGRpbi5zZXRFbmNvZGluZyhlbmNvZGluZyk7XG5cbiAgc3RkaW4uc2V0UmF3TW9kZShyYXdNb2RlKTtcblxuICBzdGRpbi5yZXN1bWUoKTtcblxuICBsZXQgdmFsdWUgPSAnJztcblxuICBzdGRpbi5vbignZGF0YScsIGZ1bmN0aW9uIChjaHVuaykge1xuICAgIGNvbnN0IGNoYXIgPSBjaHVuay50b1N0cmluZyhlbmNvZGluZyk7XG5cbiAgICBzd2l0Y2ggKGNoYXIpIHtcbiAgICAgIGNhc2UgTElORV9GRUVEIDpcbiAgICAgIGNhc2UgQ0FSUklBR0VfUkVUVVJOIDpcbiAgICAgICAgc3Rkb3V0LndyaXRlKExJTkVfRkVFRCk7XG5cbiAgICAgICAgc3RkaW4ucmVtb3ZlQWxsTGlzdGVuZXJzKCdkYXRhJyk7XG5cbiAgICAgICAgc3RkaW4ucGF1c2UoKTtcblxuICAgICAgICBjYWxsYmFjayh2YWx1ZSk7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlIENUUkxfQyA6XG4gICAgICAgIGNvbnNvbGUubG9nKCk7XG5cbiAgICAgICAgcHJvY2Vzcy5leGl0KCk7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlIEJBQ0tTUEFDRSA6XG4gICAgICAgIHZhbHVlID0gdHJ1bmNhdGUodmFsdWUpO1xuXG4gICAgICAgIHN0ZG91dC5jbGVhckxpbmUoKTtcblxuICAgICAgICBzdGRvdXQuY3Vyc29yVG8oMCk7XG5cbiAgICAgICAgc3Rkb3V0LndyaXRlKGRlc2NyaXB0aW9uKTtcbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHZhbHVlICs9IGNoYXI7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHRydW5jYXRlKHZhbHVlKSB7IHJldHVybiB2YWx1ZS5zbGljZSgwLCB2YWx1ZS5sZW5ndGggLSAxKTsgfVxuIl19