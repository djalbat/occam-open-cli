'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var fsExtra = require('fs-extra');

var pathUtil = require('./util/path'),
    pathMapsUtil = require('./util/pathMaps');

var helpers = function () {
  function helpers() {
    _classCallCheck(this, helpers);
  }

  _createClass(helpers, null, [{
    key: 'moveEntries',
    value: function moveEntries(pathMaps, projectsDirectoryPath, callback) {
      var targetPaths = [];

      pathMapsUtil.asyncForEachWithSourcePathAndTargetPath(pathMaps, function (sourcePath, targetPath, next) {
        moveEntry(sourcePath, targetPath, projectsDirectoryPath, function (targetPath) {
          targetPaths.push(targetPath);

          next();
        });
      }, function () {
        callback(targetPaths);
      });
    }
  }, {
    key: 'removeEntries',
    value: function removeEntries(pathMaps, projectsDirectoryPath, callback) {
      var targetPaths = [];

      pathMapsUtil.asyncForEachWithSourcePathAndTargetPath(pathMaps, function (sourcePath, targetPath, next) {
        removeEntry(sourcePath, targetPath, projectsDirectoryPath, function (targetPath) {
          targetPaths.push(targetPath);

          next();
        });
      }, function () {
        callback(targetPaths);
      });
    }
  }]);

  return helpers;
}();

module.exports = helpers;

function moveEntry(sourcePath, targetPath, projectsDirectoryPath, callback) {
  if (sourcePath === targetPath) {
    callback(targetPath);
  } else {
    var absoluteSourcePath = pathUtil.combinePaths(projectsDirectoryPath, sourcePath),
        exists = fsExtra.existsSync(absoluteSourcePath);

    if (!exists) {
      targetPath = null;

      callback(targetPath);
    } else {
      var absoluteSourcePathDirectoryPath = pathUtil.isAbsolutePathDirectoryPath(absoluteSourcePath),
          entryDirectory = absoluteSourcePathDirectoryPath;

      entryDirectory ? moveDirectory(sourcePath, targetPath, projectsDirectoryPath, callback) : moveFile(sourcePath, targetPath, projectsDirectoryPath, callback);
    }
  }
}

function removeEntry(sourcePath, targetPath, projectsDirectoryPath, callback) {
  if (sourcePath === targetPath) {
    callback(targetPath);
  } else {
    var absoluteSourcePath = pathUtil.combinePaths(projectsDirectoryPath, sourcePath),
        exists = fsExtra.existsSync(absoluteSourcePath);

    if (!exists) {
      targetPath = null;

      callback(targetPath);
    } else {
      var absoluteSourcePathDirectoryPath = pathUtil.isAbsolutePathDirectoryPath(absoluteSourcePath),
          entryDirectory = absoluteSourcePathDirectoryPath;

      entryDirectory ? removeDirectory(sourcePath, projectsDirectoryPath, callback) : removeFile(sourcePath, projectsDirectoryPath, callback);
    }
  }
}

function moveFile(sourcePath, targetPath, projectsDirectoryPath, callback) {
  var absoluteSourcePath = pathUtil.combinePaths(projectsDirectoryPath, sourcePath),
      absoluteTargetPath = pathUtil.combinePaths(projectsDirectoryPath, targetPath);

  fsExtra.move(absoluteSourcePath, absoluteTargetPath, function (err) {
    var success = err === null;

    targetPath = success ? targetPath : sourcePath;

    callback(targetPath);
  });
}

function removeFile(sourcePath, projectsDirectoryPath, callback) {
  var absoluteSourcePath = pathUtil.combinePaths(projectsDirectoryPath, sourcePath);

  fsExtra.remove(absoluteSourcePath, function (err) {
    var success = err === null,
        targetPath = success ? null : sourcePath;

    callback(targetPath);
  });
}

function moveDirectory(sourcePath, targetPath, projectsDirectoryPath, callback) {
  var absoluteSourcePath = pathUtil.combinePaths(projectsDirectoryPath, sourcePath),
      absoluteTargetPath = pathUtil.combinePaths(projectsDirectoryPath, targetPath),
      empty = pathUtil.isAbsoluteDirectoryPathEmpty(absoluteSourcePath);

  if (!empty) {
    var _targetPath = sourcePath;

    callback(_targetPath);
  } else {
    fsExtra.move(absoluteSourcePath, absoluteTargetPath, function (err) {
      var success = err === null;

      if (success) {
        callback(targetPath);
      } else {
        var errCode = err.code; ///

        if (errCode !== 'EEXIST') {
          var _targetPath2 = sourcePath;

          callback(_targetPath2);
        } else {
          fsExtra.remove(absoluteSourcePath, function (err) {
            var success = err === null;

            if (!success) {
              targetPath = sourcePath;
            }

            callback(targetPath);
          });
        }
      }
    });
  }
}

function removeDirectory(sourcePath, projectsDirectoryPath, callback) {
  var absoluteSourcePath = pathUtil.combinePaths(projectsDirectoryPath, sourcePath),
      empty = pathUtil.isAbsoluteDirectoryPathEmpty(absoluteSourcePath);

  if (!empty) {
    var targetPath = sourcePath;

    callback(targetPath);
  } else {
    fsExtra.remove(absoluteSourcePath, function (err) {
      var success = err === null,
          targetPath = success ? null : sourcePath;

      callback(targetPath);
    });
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9oZWxwZXJzLmpzIl0sIm5hbWVzIjpbImZzRXh0cmEiLCJyZXF1aXJlIiwicGF0aFV0aWwiLCJwYXRoTWFwc1V0aWwiLCJoZWxwZXJzIiwicGF0aE1hcHMiLCJwcm9qZWN0c0RpcmVjdG9yeVBhdGgiLCJjYWxsYmFjayIsInRhcmdldFBhdGhzIiwiYXN5bmNGb3JFYWNoV2l0aFNvdXJjZVBhdGhBbmRUYXJnZXRQYXRoIiwic291cmNlUGF0aCIsInRhcmdldFBhdGgiLCJuZXh0IiwibW92ZUVudHJ5IiwicHVzaCIsInJlbW92ZUVudHJ5IiwibW9kdWxlIiwiZXhwb3J0cyIsImFic29sdXRlU291cmNlUGF0aCIsImNvbWJpbmVQYXRocyIsImV4aXN0cyIsImV4aXN0c1N5bmMiLCJhYnNvbHV0ZVNvdXJjZVBhdGhEaXJlY3RvcnlQYXRoIiwiaXNBYnNvbHV0ZVBhdGhEaXJlY3RvcnlQYXRoIiwiZW50cnlEaXJlY3RvcnkiLCJtb3ZlRGlyZWN0b3J5IiwibW92ZUZpbGUiLCJyZW1vdmVEaXJlY3RvcnkiLCJyZW1vdmVGaWxlIiwiYWJzb2x1dGVUYXJnZXRQYXRoIiwibW92ZSIsImVyciIsInN1Y2Nlc3MiLCJyZW1vdmUiLCJlbXB0eSIsImlzQWJzb2x1dGVEaXJlY3RvcnlQYXRoRW1wdHkiLCJlcnJDb2RlIiwiY29kZSJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztBQUVBLElBQU1BLFVBQVVDLFFBQVEsVUFBUixDQUFoQjs7QUFFQSxJQUFNQyxXQUFXRCxRQUFRLGFBQVIsQ0FBakI7QUFBQSxJQUNNRSxlQUFlRixRQUFRLGlCQUFSLENBRHJCOztJQUdNRyxPOzs7Ozs7O2dDQUNlQyxRLEVBQVVDLHFCLEVBQXVCQyxRLEVBQVU7QUFDNUQsVUFBTUMsY0FBYyxFQUFwQjs7QUFFQUwsbUJBQWFNLHVDQUFiLENBQ0VKLFFBREYsRUFFRSxVQUFTSyxVQUFULEVBQXFCQyxVQUFyQixFQUFpQ0MsSUFBakMsRUFBdUM7QUFDckNDLGtCQUFVSCxVQUFWLEVBQXNC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SUMsT0FBSixFQUFhO0FBQ1h6QixpQkFBU0ksVUFBVDtBQUNELE9BRkQsTUFFTztBQUNMLFlBQU15QixVQUFVTCxJQUFJTSxJQUFwQixDQURLLENBQ3FCOztBQUUxQixZQUFJRCxZQUFZLFFBQWhCLEVBQTBCO0FBQ3hCLGNBQU16QixlQUFhRCxVQUFuQjs7QUFFQUgsbUJBQVNJLFlBQVQ7QUFDRCxTQUpELE1BSU87QUFDTFgsa0JBQVFpQyxNQUFSLENBQWVmLGtCQUFmLEVBQW1DLFVBQVNhLEdBQVQsRUFBYztBQUMvQyxnQkFBTUMsVUFBV0QsUUFBUSxJQUF6Qjs7QUFFQSxnQkFBSSxDQUFDQyxPQUFMLEVBQWM7QUFDWnJCLDJCQUFhRCxVQUFiO0FBQ0Q7O0FBRURILHFCQUFTSSxVQUFUO0FBQ0QsV0FSRDtBQVNEO0FBQ0Y7QUFDRixLQXhCRDtBQXlCRDtBQUNGOztBQUVELFNBQVNnQixlQUFULENBQXlCakIsVUFBekIsRUFBcUNKLHFCQUFyQyxFQUE0REMsUUFBNUQsRUFBc0U7QUFDcEUsTUFBTVcscUJBQXFCaEIsU0FBU2lCLFlBQVQsQ0FBc0JiLHFCQUF0QixFQUE2Q0ksVUFBN0MsQ0FBM0I7QUFBQSxNQUNNd0IsUUFBUWhDLFNBQVNpQyw0QkFBVCxDQUFzQ2pCLGtCQUF0QyxDQURkOztBQUdBLE1BQUksQ0FBQ2dCLEtBQUwsRUFBWTtBQUNWLFFBQU12QixhQUFhRCxVQUFuQjs7QUFFQUgsYUFBU0ksVUFBVDtBQUNELEdBSkQsTUFJTztBQUNMWCxZQUFRaUMsTUFBUixDQUFlZixrQkFBZixFQUFtQyxVQUFTYSxHQUFULEVBQWM7QUFDL0MsVUFBTUMsVUFBV0QsUUFBUSxJQUF6QjtBQUFBLFVBQ01wQixhQUFhcUIsVUFDRyxJQURILEdBRUt0QixVQUh4Qjs7QUFLQUgsZUFBU0ksVUFBVDtBQUNELEtBUEQ7QUFRRDtBQUNGIiwiZmlsZSI6ImhlbHBlcnMuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IGZzRXh0cmEgPSByZXF1aXJlKCdmcy1leHRyYScpO1xuXG5jb25zdCBwYXRoVXRpbCA9IHJlcXVpcmUoJy4vdXRpbC9wYXRoJyksXG4gICAgICBwYXRoTWFwc1V0aWwgPSByZXF1aXJlKCcuL3V0aWwvcGF0aE1hcHMnKTtcblxuY2xhc3MgaGVscGVycyB7XG4gIHN0YXRpYyBtb3ZlRW50cmllcyhwYXRoTWFwcywgcHJvamVjdHNEaXJlY3RvcnlQYXRoLCBjYWxsYmFjaykge1xuICAgIGNvbnN0IHRhcmdldFBhdGhzID0gW107XG5cbiAgICBwYXRoTWFwc1V0aWwuYXN5bmNGb3JFYWNoV2l0aFNvdXJjZVBhdGhBbmRUYXJnZXRQYXRoKFxuICAgICAgcGF0aE1hcHMsIFxuICAgICAgZnVuY3Rpb24oc291cmNlUGF0aCwgdGFyZ2V0UGF0aCwgbmV4dCkge1xuICAgICAgICBtb3ZlRW50cnkoc291cmNlUGF0aCwgdGFyZ2V0UGF0aCwgcHJvamVjdHNEaXJlY3RvcnlQYXRoLCBmdW5jdGlvbih0YXJnZXRQYXRoKSB7XG4gICAgICAgICAgdGFyZ2V0UGF0aHMucHVzaCh0YXJnZXRQYXRoKTtcbiAgICAgICAgICBcbiAgICAgICAgICBuZXh0KCk7XG4gICAgICAgIH0pO1xuICAgICAgfSxcbiAgICAgIGZ1bmN0aW9uKCkge1xuICAgICAgICBjYWxsYmFjayh0YXJnZXRQYXRocyk7XG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIHN0YXRpYyByZW1vdmVFbnRyaWVzKHBhdGhNYXBzLCBwcm9qZWN0c0RpcmVjdG9yeVBhdGgsIGNhbGxiYWNrKSB7XG4gICAgY29uc3QgdGFyZ2V0UGF0aHMgPSBbXTtcblxuICAgIHBhdGhNYXBzVXRpbC5hc3luY0ZvckVhY2hXaXRoU291cmNlUGF0aEFuZFRhcmdldFBhdGgoXG4gICAgICBwYXRoTWFwcyxcbiAgICAgIGZ1bmN0aW9uKHNvdXJjZVBhdGgsIHRhcmdldFBhdGgsIG5leHQpIHtcbiAgICAgICAgcmVtb3ZlRW50cnkoc291cmNlUGF0aCwgdGFyZ2V0UGF0aCwgcHJvamVjdHNEaXJlY3RvcnlQYXRoLCBmdW5jdGlvbih0YXJnZXRQYXRoKSB7XG4gICAgICAgICAgdGFyZ2V0UGF0aHMucHVzaCh0YXJnZXRQYXRoKTtcblxuICAgICAgICAgIG5leHQoKTtcbiAgICAgICAgfSk7XG4gICAgICB9LFxuICAgICAgZnVuY3Rpb24oKSB7XG4gICAgICAgIGNhbGxiYWNrKHRhcmdldFBhdGhzKTtcbiAgICAgIH1cbiAgICApO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gaGVscGVycztcblxuZnVuY3Rpb24gbW92ZUVudHJ5KHNvdXJjZVBhdGgsIHRhcmdldFBhdGgsIHByb2plY3RzRGlyZWN0b3J5UGF0aCwgY2FsbGJhY2spIHtcbiAgaWYgKHNvdXJjZVBhdGggPT09IHRhcmdldFBhdGgpIHtcbiAgICBjYWxsYmFjayh0YXJnZXRQYXRoKTtcbiAgfSBlbHNlIHtcbiAgICBjb25zdCBhYnNvbHV0ZVNvdXJjZVBhdGggPSBwYXRoVXRpbC5jb21iaW5lUGF0aHMocHJvamVjdHNEaXJlY3RvcnlQYXRoLCBzb3VyY2VQYXRoKSxcbiAgICAgICAgICBleGlzdHMgPSBmc0V4dHJhLmV4aXN0c1N5bmMoYWJzb2x1dGVTb3VyY2VQYXRoKTtcblxuICAgIGlmICghZXhpc3RzKSB7XG4gICAgICB0YXJnZXRQYXRoID0gbnVsbDtcblxuICAgICAgY2FsbGJhY2sodGFyZ2V0UGF0aCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGFic29sdXRlU291cmNlUGF0aERpcmVjdG9yeVBhdGggPSBwYXRoVXRpbC5pc0Fic29sdXRlUGF0aERpcmVjdG9yeVBhdGgoYWJzb2x1dGVTb3VyY2VQYXRoKSxcbiAgICAgICAgICAgIGVudHJ5RGlyZWN0b3J5ID0gYWJzb2x1dGVTb3VyY2VQYXRoRGlyZWN0b3J5UGF0aDtcblxuICAgICAgZW50cnlEaXJlY3RvcnkgP1xuICAgICAgICBtb3ZlRGlyZWN0b3J5KHNvdXJjZVBhdGgsIHRhcmdldFBhdGgsIHByb2plY3RzRGlyZWN0b3J5UGF0aCwgY2FsbGJhY2spIDpcbiAgICAgICAgICBtb3ZlRmlsZShzb3VyY2VQYXRoLCB0YXJnZXRQYXRoLCBwcm9qZWN0c0RpcmVjdG9yeVBhdGgsIGNhbGxiYWNrKTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gcmVtb3ZlRW50cnkoc291cmNlUGF0aCwgdGFyZ2V0UGF0aCwgcHJvamVjdHNEaXJlY3RvcnlQYXRoLCBjYWxsYmFjaykge1xuICBpZiAoc291cmNlUGF0aCA9PT0gdGFyZ2V0UGF0aCkge1xuICAgIGNhbGxiYWNrKHRhcmdldFBhdGgpO1xuICB9IGVsc2Uge1xuICAgIGNvbnN0IGFic29sdXRlU291cmNlUGF0aCA9IHBhdGhVdGlsLmNvbWJpbmVQYXRocyhwcm9qZWN0c0RpcmVjdG9yeVBhdGgsIHNvdXJjZVBhdGgpLFxuICAgICAgICAgIGV4aXN0cyA9IGZzRXh0cmEuZXhpc3RzU3luYyhhYnNvbHV0ZVNvdXJjZVBhdGgpO1xuXG4gICAgaWYgKCFleGlzdHMpIHtcbiAgICAgIHRhcmdldFBhdGggPSBudWxsO1xuXG4gICAgICBjYWxsYmFjayh0YXJnZXRQYXRoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgYWJzb2x1dGVTb3VyY2VQYXRoRGlyZWN0b3J5UGF0aCA9IHBhdGhVdGlsLmlzQWJzb2x1dGVQYXRoRGlyZWN0b3J5UGF0aChhYnNvbHV0ZVNvdXJjZVBhdGgpLFxuICAgICAgICAgICAgZW50cnlEaXJlY3RvcnkgPSBhYnNvbHV0ZVNvdXJjZVBhdGhEaXJlY3RvcnlQYXRoO1xuXG4gICAgICBlbnRyeURpcmVjdG9yeSA/XG4gICAgICAgIHJlbW92ZURpcmVjdG9yeShzb3VyY2VQYXRoLCBwcm9qZWN0c0RpcmVjdG9yeVBhdGgsIGNhbGxiYWNrKSA6XG4gICAgICAgICAgcmVtb3ZlRmlsZShzb3VyY2VQYXRoLCBwcm9qZWN0c0RpcmVjdG9yeVBhdGgsIGNhbGxiYWNrKTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gbW92ZUZpbGUoc291cmNlUGF0aCwgdGFyZ2V0UGF0aCwgcHJvamVjdHNEaXJlY3RvcnlQYXRoLCBjYWxsYmFjaykge1xuICBjb25zdCBhYnNvbHV0ZVNvdXJjZVBhdGggPSBwYXRoVXRpbC5jb21iaW5lUGF0aHMocHJvamVjdHNEaXJlY3RvcnlQYXRoLCBzb3VyY2VQYXRoKSxcbiAgICAgICAgYWJzb2x1dGVUYXJnZXRQYXRoID0gcGF0aFV0aWwuY29tYmluZVBhdGhzKHByb2plY3RzRGlyZWN0b3J5UGF0aCwgdGFyZ2V0UGF0aCk7XG5cbiAgZnNFeHRyYS5tb3ZlKGFic29sdXRlU291cmNlUGF0aCwgYWJzb2x1dGVUYXJnZXRQYXRoLCBmdW5jdGlvbiAoZXJyKSB7XG4gICAgY29uc3Qgc3VjY2VzcyA9IChlcnIgPT09IG51bGwpO1xuICAgIFxuICAgIHRhcmdldFBhdGggPSBzdWNjZXNzID9cbiAgICAgICAgICAgICAgICAgICB0YXJnZXRQYXRoIDpcbiAgICAgICAgICAgICAgICAgICAgIHNvdXJjZVBhdGg7XG5cbiAgICBjYWxsYmFjayh0YXJnZXRQYXRoKTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJlbW92ZUZpbGUoc291cmNlUGF0aCwgcHJvamVjdHNEaXJlY3RvcnlQYXRoLCBjYWxsYmFjaykge1xuICBjb25zdCBhYnNvbHV0ZVNvdXJjZVBhdGggPSBwYXRoVXRpbC5jb21iaW5lUGF0aHMocHJvamVjdHNEaXJlY3RvcnlQYXRoLCBzb3VyY2VQYXRoKTtcblxuICBmc0V4dHJhLnJlbW92ZShhYnNvbHV0ZVNvdXJjZVBhdGgsIGZ1bmN0aW9uKGVycikge1xuICAgIGNvbnN0IHN1Y2Nlc3MgPSAoZXJyID09PSBudWxsKSxcbiAgICAgICAgICB0YXJnZXRQYXRoID0gc3VjY2VzcyA/XG4gICAgICAgICAgICAgICAgICAgICAgICAgbnVsbCA6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICBzb3VyY2VQYXRoO1xuXG4gICAgY2FsbGJhY2sodGFyZ2V0UGF0aCk7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBtb3ZlRGlyZWN0b3J5KHNvdXJjZVBhdGgsIHRhcmdldFBhdGgsIHByb2plY3RzRGlyZWN0b3J5UGF0aCwgY2FsbGJhY2spIHtcbiAgY29uc3QgYWJzb2x1dGVTb3VyY2VQYXRoID0gcGF0aFV0aWwuY29tYmluZVBhdGhzKHByb2plY3RzRGlyZWN0b3J5UGF0aCwgc291cmNlUGF0aCksXG4gICAgICAgIGFic29sdXRlVGFyZ2V0UGF0aCA9IHBhdGhVdGlsLmNvbWJpbmVQYXRocyhwcm9qZWN0c0RpcmVjdG9yeVBhdGgsIHRhcmdldFBhdGgpLFxuICAgICAgICBlbXB0eSA9IHBhdGhVdGlsLmlzQWJzb2x1dGVEaXJlY3RvcnlQYXRoRW1wdHkoYWJzb2x1dGVTb3VyY2VQYXRoKTtcblxuICBpZiAoIWVtcHR5KSB7XG4gICAgY29uc3QgdGFyZ2V0UGF0aCA9IHNvdXJjZVBhdGg7XG5cbiAgICBjYWxsYmFjayh0YXJnZXRQYXRoKTtcbiAgfSBlbHNlIHtcbiAgICBmc0V4dHJhLm1vdmUoYWJzb2x1dGVTb3VyY2VQYXRoLCBhYnNvbHV0ZVRhcmdldFBhdGgsIGZ1bmN0aW9uIChlcnIpIHtcbiAgICAgIGNvbnN0IHN1Y2Nlc3MgPSAoZXJyID09PSBudWxsKTtcblxuICAgICAgaWYgKHN1Y2Nlc3MpIHtcbiAgICAgICAgY2FsbGJhY2sodGFyZ2V0UGF0aCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBlcnJDb2RlID0gZXJyLmNvZGU7IC8vL1xuXG4gICAgICAgIGlmIChlcnJDb2RlICE9PSAnRUVYSVNUJykge1xuICAgICAgICAgIGNvbnN0IHRhcmdldFBhdGggPSBzb3VyY2VQYXRoO1xuXG4gICAgICAgICAgY2FsbGJhY2sodGFyZ2V0UGF0aCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZnNFeHRyYS5yZW1vdmUoYWJzb2x1dGVTb3VyY2VQYXRoLCBmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICAgIGNvbnN0IHN1Y2Nlc3MgPSAoZXJyID09PSBudWxsKTtcblxuICAgICAgICAgICAgaWYgKCFzdWNjZXNzKSB7XG4gICAgICAgICAgICAgIHRhcmdldFBhdGggPSBzb3VyY2VQYXRoO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjYWxsYmFjayh0YXJnZXRQYXRoKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9XG59XG5cbmZ1bmN0aW9uIHJlbW92ZURpcmVjdG9yeShzb3VyY2VQYXRoLCBwcm9qZWN0c0RpcmVjdG9yeVBhdGgsIGNhbGxiYWNrKSB7XG4gIGNvbnN0IGFic29sdXRlU291cmNlUGF0aCA9IHBhdGhVdGlsLmNvbWJpbmVQYXRocyhwcm9qZWN0c0RpcmVjdG9yeVBhdGgsIHNvdXJjZVBhdGgpLFxuICAgICAgICBlbXB0eSA9IHBhdGhVdGlsLmlzQWJzb2x1dGVEaXJlY3RvcnlQYXRoRW1wdHkoYWJzb2x1dGVTb3VyY2VQYXRoKTtcblxuICBpZiAoIWVtcHR5KSB7XG4gICAgY29uc3QgdGFyZ2V0UGF0aCA9IHNvdXJjZVBhdGg7XG5cbiAgICBjYWxsYmFjayh0YXJnZXRQYXRoKTtcbiAgfSBlbHNlIHtcbiAgICBmc0V4dHJhLnJlbW92ZShhYnNvbHV0ZVNvdXJjZVBhdGgsIGZ1bmN0aW9uKGVycikge1xuICAgICAgY29uc3Qgc3VjY2VzcyA9IChlcnIgPT09IG51bGwpLFxuICAgICAgICAgICAgdGFyZ2V0UGF0aCA9IHN1Y2Nlc3MgP1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG51bGwgOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc291cmNlUGF0aDtcblxuICAgICAgY2FsbGJhY2sodGFyZ2V0UGF0aCk7XG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==