'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var fsExtra = require('fs-extra'),
    necessary = require('necessary');

var pathMapsUtilities = require('./utilities/pathMaps');

var path = necessary.path,
    fileSystem = necessary.fileSystem,
    concatenatePaths = path.concatenatePaths,
    entryExists = fileSystem.entryExists,
    isDirectoryEmpty = fileSystem.isDirectoryEmpty;

var helpers = function () {
  function helpers() {
    _classCallCheck(this, helpers);
  }

  _createClass(helpers, null, [{
    key: 'moveEntries',
    value: function moveEntries(pathMaps, projectsDirectoryPath, callback) {
      var targetPaths = [];

      pathMapsUtilities.asyncForEachWithSourcePathAndTargetPath(pathMaps, function (sourcePath, targetPath, next) {
        moveEntry(sourcePath, targetPath, projectsDirectoryPath, function (targetPath) {
          targetPaths.push(targetPath);

          next();
        });
      }, function () {
        callback(targetPaths);
      });
    }
  }, {
    key: 'removeEntries',
    value: function removeEntries(pathMaps, projectsDirectoryPath, callback) {
      var targetPaths = [];

      pathMapsUtilities.asyncForEachWithSourcePathAndTargetPath(pathMaps, function (sourcePath, targetPath, next) {
        removeEntry(sourcePath, targetPath, projectsDirectoryPath, function (targetPath) {
          targetPaths.push(targetPath);

          next();
        });
      }, function () {
        callback(targetPaths);
      });
    }
  }]);

  return helpers;
}();

module.exports = helpers;

function moveEntry(sourcePath, targetPath, projectsDirectoryPath, callback) {
  if (sourcePath === targetPath) {
    callback(targetPath);
  } else {
    var absoluteSourcePath = concatenatePaths(projectsDirectoryPath, sourcePath),
        exists = entryExists(absoluteSourcePath);

    if (!exists) {
      targetPath = null;

      callback(targetPath);
    } else {
      var entryDirectory = isEntryDirectory(absoluteSourcePath);

      entryDirectory ? moveDirectory(sourcePath, targetPath, projectsDirectoryPath, callback) : moveFile(sourcePath, targetPath, projectsDirectoryPath, callback);
    }
  }
}

function removeEntry(sourcePath, targetPath, projectsDirectoryPath, callback) {
  if (sourcePath === targetPath) {
    callback(targetPath);
  } else {
    var absoluteSourcePath = concatenatePaths(projectsDirectoryPath, sourcePath),
        exists = entryExists(absoluteSourcePath);

    if (!exists) {
      targetPath = null;

      callback(targetPath);
    } else {
      var entryDirectory = isEntryDirectory(absoluteSourcePath);

      entryDirectory ? removeDirectory(sourcePath, projectsDirectoryPath, callback) : removeFile(sourcePath, projectsDirectoryPath, callback);
    }
  }
}

function moveFile(sourcePath, targetPath, projectsDirectoryPath, callback) {
  var absoluteSourcePath = concatenatePaths(projectsDirectoryPath, sourcePath),
      absoluteTargetPath = concatenatePaths(projectsDirectoryPath, targetPath);

  fsExtra.move(absoluteSourcePath, absoluteTargetPath, function (err) {
    var success = err === null;

    targetPath = success ? targetPath : sourcePath;

    callback(targetPath);
  });
}

function removeFile(sourcePath, projectsDirectoryPath, callback) {
  var absoluteSourcePath = concatenatePaths(projectsDirectoryPath, sourcePath);

  fsExtra.remove(absoluteSourcePath, function (err) {
    var success = err === null,
        targetPath = success ? null : sourcePath;

    callback(targetPath);
  });
}

function moveDirectory(sourcePath, targetPath, projectsDirectoryPath, callback) {
  var absoluteSourcePath = concatenatePaths(projectsDirectoryPath, sourcePath),
      absoluteTargetPath = concatenatePaths(projectsDirectoryPath, targetPath),
      empty = isDirectoryEmpty(absoluteSourcePath);

  if (!empty) {
    var _targetPath = sourcePath;

    callback(_targetPath);
  } else {
    fsExtra.move(absoluteSourcePath, absoluteTargetPath, function (err) {
      var success = err === null;

      if (success) {
        callback(targetPath);
      } else {
        var errCode = err.code; ///

        if (errCode !== 'EEXIST') {
          var _targetPath2 = sourcePath;

          callback(_targetPath2);
        } else {
          fsExtra.remove(absoluteSourcePath, function (err) {
            var success = err === null;

            if (!success) {
              targetPath = sourcePath;
            }

            callback(targetPath);
          });
        }
      }
    });
  }
}

function removeDirectory(sourcePath, projectsDirectoryPath, callback) {
  var absoluteSourcePath = concatenatePaths(projectsDirectoryPath, sourcePath),
      empty = isDirectoryEmpty(absoluteSourcePath);

  if (!empty) {
    var targetPath = sourcePath;

    callback(targetPath);
  } else {
    fsExtra.remove(absoluteSourcePath, function (err) {
      var success = err === null,
          targetPath = success ? null : sourcePath;

      callback(targetPath);
    });
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9oZWxwZXJzLmpzIl0sIm5hbWVzIjpbImZzRXh0cmEiLCJyZXF1aXJlIiwibmVjZXNzYXJ5IiwicGF0aE1hcHNVdGlsaXRpZXMiLCJwYXRoIiwiZmlsZVN5c3RlbSIsImNvbmNhdGVuYXRlUGF0aHMiLCJlbnRyeUV4aXN0cyIsImlzRGlyZWN0b3J5RW1wdHkiLCJoZWxwZXJzIiwicGF0aE1hcHMiLCJwcm9qZWN0c0RpcmVjdG9yeVBhdGgiLCJjYWxsYmFjayIsInRhcmdldFBhdGhzIiwiYXN5bmNGb3JFYWNoV2l0aFNvdXJjZVBhdGhBbmRUYXJnZXRQYXRoIiwic291cmNlUGF0aCIsInRhcmdldFBhdGgiLCJuZXh0IiwibW92ZUVudHJ5IiwicHVzaCIsInJlbW92ZUVudHJ5IiwibW9kdWxlIiwiZXhwb3J0cyIsImFic29sdXRlU291cmNlUGF0aCIsImV4aXN0cyIsImVudHJ5RGlyZWN0b3J5IiwiaXNFbnRyeURpcmVjdG9yeSIsIm1vdmVEaXJlY3RvcnkiLCJtb3ZlRmlsZSIsInJlbW92ZURpcmVjdG9yeSIsInJlbW92ZUZpbGUiLCJhYnNvbHV0ZVRhcmdldFBhdGgiLCJtb3ZlIiwiZXJyIiwic3VjY2VzcyIsInJlbW92ZSIsImVtcHR5IiwiZXJyQ29kZSIsImNvZGUiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7QUFFQSxJQUFNQSxVQUFVQyxRQUFRLFVBQVIsQ0FBaEI7QUFBQSxJQUNNQyxZQUFZRCxRQUFRLFdBQVIsQ0FEbEI7O0FBR0EsSUFBTUUsb0JBQW9CRixRQUFRLHNCQUFSLENBQTFCOztJQUVRRyxJLEdBQXFCRixTLENBQXJCRSxJO0lBQU1DLFUsR0FBZUgsUyxDQUFmRyxVO0lBQ05DLGdCLEdBQXFCRixJLENBQXJCRSxnQjtJQUNBQyxXLEdBQWtDRixVLENBQWxDRSxXO0lBQWFDLGdCLEdBQXFCSCxVLENBQXJCRyxnQjs7SUFFZkMsTzs7Ozs7OztnQ0FDZUMsUSxFQUFVQyxxQixFQUF1QkMsUSxFQUFVO0FBQzVELFVBQU1DLGNBQWMs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Qjs7QUFFMUIsWUFBSUQsWUFBWSxRQUFoQixFQUEwQjtBQUN4QixjQUFNckIsZUFBYUQsVUFBbkI7O0FBRUFILG1CQUFTSSxZQUFUO0FBQ0QsU0FKRCxNQUlPO0FBQ0xoQixrQkFBUW1DLE1BQVIsQ0FBZVosa0JBQWYsRUFBbUMsVUFBU1UsR0FBVCxFQUFjO0FBQy9DLGdCQUFNQyxVQUFXRCxRQUFRLElBQXpCOztBQUVBLGdCQUFJLENBQUNDLE9BQUwsRUFBYztBQUNabEIsMkJBQWFELFVBQWI7QUFDRDs7QUFFREgscUJBQVNJLFVBQVQ7QUFDRCxXQVJEO0FBU0Q7QUFDRjtBQUNGLEtBeEJEO0FBeUJEO0FBQ0Y7O0FBRUQsU0FBU2EsZUFBVCxDQUF5QmQsVUFBekIsRUFBcUNKLHFCQUFyQyxFQUE0REMsUUFBNUQsRUFBc0U7QUFDcEUsTUFBTVcscUJBQXFCakIsaUJBQWlCSyxxQkFBakIsRUFBd0NJLFVBQXhDLENBQTNCO0FBQUEsTUFDTXFCLFFBQVE1QixpQkFBaUJlLGtCQUFqQixDQURkOztBQUdBLE1BQUksQ0FBQ2EsS0FBTCxFQUFZO0FBQ1YsUUFBTXBCLGFBQWFELFVBQW5COztBQUVBSCxhQUFTSSxVQUFUO0FBQ0QsR0FKRCxNQUlPO0FBQ0xoQixZQUFRbUMsTUFBUixDQUFlWixrQkFBZixFQUFtQyxVQUFTVSxHQUFULEVBQWM7QUFDL0MsVUFBTUMsVUFBV0QsUUFBUSxJQUF6QjtBQUFBLFVBQ01qQixhQUFha0IsVUFDRyxJQURILEdBRUtuQixVQUh4Qjs7QUFLQUgsZUFBU0ksVUFBVDtBQUNELEtBUEQ7QUFRRDtBQUNGIiwiZmlsZSI6ImhlbHBlcnMuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IGZzRXh0cmEgPSByZXF1aXJlKCdmcy1leHRyYScpLFxuICAgICAgbmVjZXNzYXJ5ID0gcmVxdWlyZSgnbmVjZXNzYXJ5Jyk7XG5cbmNvbnN0IHBhdGhNYXBzVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvcGF0aE1hcHMnKTtcblxuY29uc3QgeyBwYXRoLCBmaWxlU3lzdGVtIH0gPSBuZWNlc3NhcnksXG4gICAgICB7IGNvbmNhdGVuYXRlUGF0aHMgfSA9IHBhdGgsXG4gICAgICB7IGVudHJ5RXhpc3RzLCBpc0RpcmVjdG9yeUVtcHR5IH0gPSBmaWxlU3lzdGVtO1xuXG5jbGFzcyBoZWxwZXJzIHtcbiAgc3RhdGljIG1vdmVFbnRyaWVzKHBhdGhNYXBzLCBwcm9qZWN0c0RpcmVjdG9yeVBhdGgsIGNhbGxiYWNrKSB7XG4gICAgY29uc3QgdGFyZ2V0UGF0aHMgPSBbXTtcblxuICAgIHBhdGhNYXBzVXRpbGl0aWVzLmFzeW5jRm9yRWFjaFdpdGhTb3VyY2VQYXRoQW5kVGFyZ2V0UGF0aChcbiAgICAgIHBhdGhNYXBzLCBcbiAgICAgIGZ1bmN0aW9uKHNvdXJjZVBhdGgsIHRhcmdldFBhdGgsIG5leHQpIHtcbiAgICAgICAgbW92ZUVudHJ5KHNvdXJjZVBhdGgsIHRhcmdldFBhdGgsIHByb2plY3RzRGlyZWN0b3J5UGF0aCwgZnVuY3Rpb24odGFyZ2V0UGF0aCkge1xuICAgICAgICAgIHRhcmdldFBhdGhzLnB1c2godGFyZ2V0UGF0aCk7XG4gICAgICAgICAgXG4gICAgICAgICAgbmV4dCgpO1xuICAgICAgICB9KTtcbiAgICAgIH0sXG4gICAgICBmdW5jdGlvbigpIHtcbiAgICAgICAgY2FsbGJhY2sodGFyZ2V0UGF0aHMpO1xuICAgICAgfVxuICAgICk7XG4gIH1cblxuICBzdGF0aWMgcmVtb3ZlRW50cmllcyhwYXRoTWFwcywgcHJvamVjdHNEaXJlY3RvcnlQYXRoLCBjYWxsYmFjaykge1xuICAgIGNvbnN0IHRhcmdldFBhdGhzID0gW107XG5cbiAgICBwYXRoTWFwc1V0aWxpdGllcy5hc3luY0ZvckVhY2hXaXRoU291cmNlUGF0aEFuZFRhcmdldFBhdGgoXG4gICAgICBwYXRoTWFwcyxcbiAgICAgIGZ1bmN0aW9uKHNvdXJjZVBhdGgsIHRhcmdldFBhdGgsIG5leHQpIHtcbiAgICAgICAgcmVtb3ZlRW50cnkoc291cmNlUGF0aCwgdGFyZ2V0UGF0aCwgcHJvamVjdHNEaXJlY3RvcnlQYXRoLCBmdW5jdGlvbih0YXJnZXRQYXRoKSB7XG4gICAgICAgICAgdGFyZ2V0UGF0aHMucHVzaCh0YXJnZXRQYXRoKTtcblxuICAgICAgICAgIG5leHQoKTtcbiAgICAgICAgfSk7XG4gICAgICB9LFxuICAgICAgZnVuY3Rpb24oKSB7XG4gICAgICAgIGNhbGxiYWNrKHRhcmdldFBhdGhzKTtcbiAgICAgIH1cbiAgICApO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gaGVscGVycztcblxuZnVuY3Rpb24gbW92ZUVudHJ5KHNvdXJjZVBhdGgsIHRhcmdldFBhdGgsIHByb2plY3RzRGlyZWN0b3J5UGF0aCwgY2FsbGJhY2spIHtcbiAgaWYgKHNvdXJjZVBhdGggPT09IHRhcmdldFBhdGgpIHtcbiAgICBjYWxsYmFjayh0YXJnZXRQYXRoKTtcbiAgfSBlbHNlIHtcbiAgICBjb25zdCBhYnNvbHV0ZVNvdXJjZVBhdGggPSBjb25jYXRlbmF0ZVBhdGhzKHByb2plY3RzRGlyZWN0b3J5UGF0aCwgc291cmNlUGF0aCksXG4gICAgICAgICAgZXhpc3RzID0gZW50cnlFeGlzdHMoYWJzb2x1dGVTb3VyY2VQYXRoKTtcblxuICAgIGlmICghZXhpc3RzKSB7XG4gICAgICB0YXJnZXRQYXRoID0gbnVsbDtcblxuICAgICAgY2FsbGJhY2sodGFyZ2V0UGF0aCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGVudHJ5RGlyZWN0b3J5ID0gaXNFbnRyeURpcmVjdG9yeShhYnNvbHV0ZVNvdXJjZVBhdGgpO1xuXG4gICAgICBlbnRyeURpcmVjdG9yeSA/XG4gICAgICAgIG1vdmVEaXJlY3Rvcnkoc291cmNlUGF0aCwgdGFyZ2V0UGF0aCwgcHJvamVjdHNEaXJlY3RvcnlQYXRoLCBjYWxsYmFjaykgOlxuICAgICAgICAgIG1vdmVGaWxlKHNvdXJjZVBhdGgsIHRhcmdldFBhdGgsIHByb2plY3RzRGlyZWN0b3J5UGF0aCwgY2FsbGJhY2spO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiByZW1vdmVFbnRyeShzb3VyY2VQYXRoLCB0YXJnZXRQYXRoLCBwcm9qZWN0c0RpcmVjdG9yeVBhdGgsIGNhbGxiYWNrKSB7XG4gIGlmIChzb3VyY2VQYXRoID09PSB0YXJnZXRQYXRoKSB7XG4gICAgY2FsbGJhY2sodGFyZ2V0UGF0aCk7XG4gIH0gZWxzZSB7XG4gICAgY29uc3QgYWJzb2x1dGVTb3VyY2VQYXRoID0gY29uY2F0ZW5hdGVQYXRocyhwcm9qZWN0c0RpcmVjdG9yeVBhdGgsIHNvdXJjZVBhdGgpLFxuICAgICAgICAgIGV4aXN0cyA9IGVudHJ5RXhpc3RzKGFic29sdXRlU291cmNlUGF0aCk7XG5cbiAgICBpZiAoIWV4aXN0cykge1xuICAgICAgdGFyZ2V0UGF0aCA9IG51bGw7XG5cbiAgICAgIGNhbGxiYWNrKHRhcmdldFBhdGgpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBlbnRyeURpcmVjdG9yeSA9IGlzRW50cnlEaXJlY3RvcnkoYWJzb2x1dGVTb3VyY2VQYXRoKTtcblxuICAgICAgZW50cnlEaXJlY3RvcnkgP1xuICAgICAgICByZW1vdmVEaXJlY3Rvcnkoc291cmNlUGF0aCwgcHJvamVjdHNEaXJlY3RvcnlQYXRoLCBjYWxsYmFjaykgOlxuICAgICAgICAgIHJlbW92ZUZpbGUoc291cmNlUGF0aCwgcHJvamVjdHNEaXJlY3RvcnlQYXRoLCBjYWxsYmFjayk7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIG1vdmVGaWxlKHNvdXJjZVBhdGgsIHRhcmdldFBhdGgsIHByb2plY3RzRGlyZWN0b3J5UGF0aCwgY2FsbGJhY2spIHtcbiAgY29uc3QgYWJzb2x1dGVTb3VyY2VQYXRoID0gY29uY2F0ZW5hdGVQYXRocyhwcm9qZWN0c0RpcmVjdG9yeVBhdGgsIHNvdXJjZVBhdGgpLFxuICAgICAgICBhYnNvbHV0ZVRhcmdldFBhdGggPSBjb25jYXRlbmF0ZVBhdGhzKHByb2plY3RzRGlyZWN0b3J5UGF0aCwgdGFyZ2V0UGF0aCk7XG5cbiAgZnNFeHRyYS5tb3ZlKGFic29sdXRlU291cmNlUGF0aCwgYWJzb2x1dGVUYXJnZXRQYXRoLCBmdW5jdGlvbiAoZXJyKSB7XG4gICAgY29uc3Qgc3VjY2VzcyA9IChlcnIgPT09IG51bGwpO1xuICAgIFxuICAgIHRhcmdldFBhdGggPSBzdWNjZXNzID9cbiAgICAgICAgICAgICAgICAgICB0YXJnZXRQYXRoIDpcbiAgICAgICAgICAgICAgICAgICAgIHNvdXJjZVBhdGg7XG5cbiAgICBjYWxsYmFjayh0YXJnZXRQYXRoKTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJlbW92ZUZpbGUoc291cmNlUGF0aCwgcHJvamVjdHNEaXJlY3RvcnlQYXRoLCBjYWxsYmFjaykge1xuICBjb25zdCBhYnNvbHV0ZVNvdXJjZVBhdGggPSBjb25jYXRlbmF0ZVBhdGhzKHByb2plY3RzRGlyZWN0b3J5UGF0aCwgc291cmNlUGF0aCk7XG5cbiAgZnNFeHRyYS5yZW1vdmUoYWJzb2x1dGVTb3VyY2VQYXRoLCBmdW5jdGlvbihlcnIpIHtcbiAgICBjb25zdCBzdWNjZXNzID0gKGVyciA9PT0gbnVsbCksXG4gICAgICAgICAgdGFyZ2V0UGF0aCA9IHN1Y2Nlc3MgP1xuICAgICAgICAgICAgICAgICAgICAgICAgIG51bGwgOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgc291cmNlUGF0aDtcblxuICAgIGNhbGxiYWNrKHRhcmdldFBhdGgpO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gbW92ZURpcmVjdG9yeShzb3VyY2VQYXRoLCB0YXJnZXRQYXRoLCBwcm9qZWN0c0RpcmVjdG9yeVBhdGgsIGNhbGxiYWNrKSB7XG4gIGNvbnN0IGFic29sdXRlU291cmNlUGF0aCA9IGNvbmNhdGVuYXRlUGF0aHMocHJvamVjdHNEaXJlY3RvcnlQYXRoLCBzb3VyY2VQYXRoKSxcbiAgICAgICAgYWJzb2x1dGVUYXJnZXRQYXRoID0gY29uY2F0ZW5hdGVQYXRocyhwcm9qZWN0c0RpcmVjdG9yeVBhdGgsIHRhcmdldFBhdGgpLFxuICAgICAgICBlbXB0eSA9IGlzRGlyZWN0b3J5RW1wdHkoYWJzb2x1dGVTb3VyY2VQYXRoKTtcblxuICBpZiAoIWVtcHR5KSB7XG4gICAgY29uc3QgdGFyZ2V0UGF0aCA9IHNvdXJjZVBhdGg7XG5cbiAgICBjYWxsYmFjayh0YXJnZXRQYXRoKTtcbiAgfSBlbHNlIHtcbiAgICBmc0V4dHJhLm1vdmUoYWJzb2x1dGVTb3VyY2VQYXRoLCBhYnNvbHV0ZVRhcmdldFBhdGgsIGZ1bmN0aW9uIChlcnIpIHtcbiAgICAgIGNvbnN0IHN1Y2Nlc3MgPSAoZXJyID09PSBudWxsKTtcblxuICAgICAgaWYgKHN1Y2Nlc3MpIHtcbiAgICAgICAgY2FsbGJhY2sodGFyZ2V0UGF0aCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBlcnJDb2RlID0gZXJyLmNvZGU7IC8vL1xuXG4gICAgICAgIGlmIChlcnJDb2RlICE9PSAnRUVYSVNUJykge1xuICAgICAgICAgIGNvbnN0IHRhcmdldFBhdGggPSBzb3VyY2VQYXRoO1xuXG4gICAgICAgICAgY2FsbGJhY2sodGFyZ2V0UGF0aCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZnNFeHRyYS5yZW1vdmUoYWJzb2x1dGVTb3VyY2VQYXRoLCBmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICAgIGNvbnN0IHN1Y2Nlc3MgPSAoZXJyID09PSBudWxsKTtcblxuICAgICAgICAgICAgaWYgKCFzdWNjZXNzKSB7XG4gICAgICAgICAgICAgIHRhcmdldFBhdGggPSBzb3VyY2VQYXRoO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjYWxsYmFjayh0YXJnZXRQYXRoKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9XG59XG5cbmZ1bmN0aW9uIHJlbW92ZURpcmVjdG9yeShzb3VyY2VQYXRoLCBwcm9qZWN0c0RpcmVjdG9yeVBhdGgsIGNhbGxiYWNrKSB7XG4gIGNvbnN0IGFic29sdXRlU291cmNlUGF0aCA9IGNvbmNhdGVuYXRlUGF0aHMocHJvamVjdHNEaXJlY3RvcnlQYXRoLCBzb3VyY2VQYXRoKSxcbiAgICAgICAgZW1wdHkgPSBpc0RpcmVjdG9yeUVtcHR5KGFic29sdXRlU291cmNlUGF0aCk7XG5cbiAgaWYgKCFlbXB0eSkge1xuICAgIGNvbnN0IHRhcmdldFBhdGggPSBzb3VyY2VQYXRoO1xuXG4gICAgY2FsbGJhY2sodGFyZ2V0UGF0aCk7XG4gIH0gZWxzZSB7XG4gICAgZnNFeHRyYS5yZW1vdmUoYWJzb2x1dGVTb3VyY2VQYXRoLCBmdW5jdGlvbihlcnIpIHtcbiAgICAgIGNvbnN0IHN1Y2Nlc3MgPSAoZXJyID09PSBudWxsKSxcbiAgICAgICAgICAgIHRhcmdldFBhdGggPSBzdWNjZXNzID9cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBudWxsIDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNvdXJjZVBhdGg7XG5cbiAgICAgIGNhbGxiYWNrKHRhcmdldFBhdGgpO1xuICAgIH0pO1xuICB9XG59XG4iXX0=